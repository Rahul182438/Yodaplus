{% extends 'registration/registration_base.html' %}

{% block user_register %}
<form method="POST" style="border:1px solid #ccc">
    {% csrf_token %}
  <div class="container">
    <h1>Login</h1>
    <hr>

    <label for="name"><b>Username</b></label>
    <input type="text" class="form-control" id="username" name="username" required>

    <label for="psw"><b>Password</b></label>
    <input type="password" class="form-control" id="password" name="password" required>


    
      <div class="alert alert-danger" style="color:#c91d12">
        <li> <strong id="errors"></strong></li>
    </div><br>
    
    

    <div class="clearfix" style="display: flex;justify-content: center;">
      
      <button type="button" class="loginbtn" onclick="login()" >Login</button>
    </div>
    <div class="clearfix" style="text-align: center;">
        Don't have an account? <a href="{% url 'api:register' %}" style="color: darkgoldenrod;"> Signup</a>
        
      </div>

  </div>
</form>


<script
  src="https://code.jquery.com/jquery-3.6.0.js"
  integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
  crossorigin="anonymous"></script>
<script>



$(document).ready(function(){

  var token = sessionStorage.getItem('Token')

  if(token){
    window.location.href = 'http://127.0.0.1:8000/dashboard-api/'
  }
  
});




function login(){


  var data = {}

  var username = $("#username").val()
  var password =  $("#password").val()
  
  data = {
    username : username,
    password : password,
  }
  $.ajax({
        type: 'POST',
        url: 'http://127.0.0.1:8000/api/login/',
        data: data,

        success: function(response){

          console.log(response,"@@@2") 
          console.log(response['token'])
          var token = response['token']
          
          if(token != null){
            sessionStorage.setItem('Token',token)
            sessionStorage.setItem('username',username)
            check_otp_verified()
            // window.location.href = 'http://127.0.0.1:8000/dashboard-api/'
          }
          

  
        },
        error: function(error){
            console.log(error,"000")
            $("#errors").html('Please enter correct username and password')
        }
    })

}


function check_otp_verified(){

  var  username = sessionStorage.getItem('username');
  console.log("####")
  $.ajax({
        type: 'GET',
        url: 'http://127.0.0.1:8000/api/verification-api/'+username+'/',
  
        success: function(response){

          otp_verified = response['is_verified']
          if(otp_verified == true){
            window.location.href = 'http://127.0.0.1:8000/dashboard-api/'
          }
          else{
            window.location.href = 'http://127.0.0.1:8000/otp-api/user='+username
          }
        },
        error: function(error){
            console.log(error,"000")
            $("#errors").html('Please enter correct username and password')
        }
    })


}

</script>
{% endblock %}

