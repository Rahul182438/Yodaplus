{% extends "api/dashboard/dashboard.html" %}
{% load static %}

{% block css_block %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">

<link rel="stylesheet" href="{% static 'css/questionbox.css' %}" >

<link rel="stylesheet" href="{% static 'css/questions.css' %}" >

{% endblock %}



{% block myblock %}
<div class="questionbox">
    <h6 style="text-align: center;margin-top: 10%;"> You have completed the test.</h6>
    <h3 style="text-align: center;margin-top: 1%;">  {{quiz.msg}}</h3>
    <div class="container"  id="user_report">

           

      </div>
</div>




<form method="POST" id="questions_form">
{% csrf_token %}

<div class="timer-box" style="margin-top: 5%;">
<input type="hidden" id="current_time" value="">
<div class="col text-right" id="timer-box" style="text-align: center;margin-right: 2%;"></div>

</div>

    
    <div class="quiz-box custom-box div-count{{forloop.counter}}" >
        
            <div class="question-number">
                Question 
            </div>
            
            
            <input type="hidden"  class="interval" value="">
            <div  id="question-text" class="question-text" >
                
            </div>
            <div id="mcq_container" class="option-container" >
                    
        
            </div>
            



            <div class="next-question-button">
                
                    <input type="button" class="btn"  onclick="save_answers()" value="Submit">
                
            </div>
    
    </div>
    

</form>

{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script>

const url = window.location.href
var quizForm = document.getElementById('questions_form')
var csrf = document.getElementsByName('csrfmiddlewaretoken')

$(document).ready(function(){

    $(".boxform").css('display','none');
    $("#welcome").css('display','none');
    time_avail();
    questions();
    
});


function questions(){

    var token = sessionStorage.getItem('Token')
    var subject = sessionStorage.getItem('subject')
    var element = ""
        $.ajax({
                type: 'GET',
                url: "http://127.0.0.1:8000/api/questions/"+subject,
                headers: {
                    "Content-type": "application/json; charset=UTF-8",
                    "Authorization": "Token " + token
                },
                success:function(data){

                    if(data.length == 0){
                        
                        $(".questionbox").show()
                        $("#questions_form").hide()
                        report()

                    }
                    else{
                        
                        $(".questionbox").hide()
                        
                        $("#questions_form").show()
                        $("#question-text").html(data[0]['question'])
                        
                        $(".interval").val(data[0]['subject']['interval'])

                        var question_type = data[0]['type']
                        
                        var question_id = data[0]['id']
                        if(question_type == 1){
                            mcq_options(question_id) 
                        }
                        else{                                
                                element += `
                                <input type="text" class="ans option-count" id="usr_one_word" name="${question_id}" value="">
                                `
                                $("#mcq_container").html(element)
                            }

                        total_time = data[0]['subject']['interval']
                        timer_func(total_time)
                    }
                    

            }
        });

        
}




function mcq_options(question_id){

    

    var token = sessionStorage.getItem('Token')
    
        $.ajax({
                type: 'GET',
                url: "http://127.0.0.1:8000/api/answers/"+question_id,
                headers: {
                    "Content-type": "application/json; charset=UTF-8",
                    "Authorization": "Token " + token
                },
                success:function(data){
                    
                    var element = ""
                    $.each(data, function(key, value) {
                    
                    element += `
                        <input class="ans option-count" type="radio" name="${value['question']}" id="${value['id']}" value="${value['answer']}"
                            required>
                        <label class="form-check-label" for="${value['id']}">${value['answer']}</label>
                        <br>
                        `

                    $("#mcq_container").html(element)
                    });    

            }
        });


}




function save_answers(){
    

    var data = {}

    var inputType = $('.option-count').attr('type')
    var user_answer = ""
    var question_id = ""
    question_id = $('.option-count').attr('name');
    if(inputType == 'radio'){
        
      user_answer = $('.option-count:checked').val()
      
    }
    else{
        user_answer = $('#usr_one_word').val()
        
    }
    if(user_answer == undefined){
        user_answer = ""
    }
    
    
    var complete = true
    var time = $("#current_time").val()

    var username = sessionStorage.getItem('username')
    var subject = sessionStorage.getItem('subject')
    data = {

        question : question_id,
        user_answer : user_answer,
        time : time,
        complete : complete,

    }
    

    var token = sessionStorage.getItem('Token')
    
        $.ajax({
                type: 'POST',
                url: 'http://127.0.0.1:8000/api/user_progress/',
                headers: {
                    "Content-type": "application/json",
                    "Authorization": "Token " + token
                },
                data: JSON.stringify(data),

                success:function(data){
                    
                    location.reload();

            }
        });


}


function report(){

    
    var token = sessionStorage.getItem('Token')
    var subject = sessionStorage.getItem('subject')
    var element = ""
        $.ajax({
                type: 'GET',
                url: "http://127.0.0.1:8000/api/reports/"+subject,
                headers: {
                    "Content-type": "application/json; charset=UTF-8",
                    "Authorization": "Token " + token
                },
                success:function(data){
                    
                    var element_report = ''
                    $.each(data, function(key, value) {
                        
                        console.log(value)
                        if(value['report'][2] == true){
                            element_report += `<div class="col p-3 text-light h6 bg-success" style="padding: 1%;line-height: 2.4;">${value['report'][0]}</div>`
                        }
                        else{
                            element_report += `<div class="col p-3 text-light h6 bg-danger" style="padding: 1%;line-height: 2.4;">${value['report'][0]}</div>`
                        }
                        

                        $("#user_report").html(element_report)
                    });
                  

            }
        });



}



function timer_func(total_time){


    time = total_time
    
    var timerBox = document.getElementById('timer-box')

    if (time.toString().length < 2) {

        timerBox.innerHTML = `<b>0${time}:00</b>`
    } 

    else {
        timerBox.innerHTML = `<b>${time}</b>`
    }

    stored_second = sessionStorage.getItem('total_time_used')
    
    let minutes = time - 1
    let seconds = 60

    if(parseInt(stored_second) > 0){
        
        const myArr = stored_second.split(".");
        seconds = 60
        
        seconds = seconds - parseFloat(myArr[1])
        
        minutes = minutes - parseFloat(myArr[0])
    }
    else{
        seconds = 0.60
        seconds = seconds - parseFloat(stored_second)
        seconds = (seconds * 100).toFixed(2)
        
    }

    let displaySeconds
    let displayMinutes
    let count = 60
    let count_minutes = 0
    
    const timer = setInterval(()=>{
        seconds --
        if (seconds < 0) {
            seconds = 59
            minutes --
        }
        if (minutes.toString().length < 2) {
            displayMinutes = '0'+minutes
        } else {
            displayMinutes = minutes
        }


        if(seconds.toString().length < 2) {
            displaySeconds = '0' + seconds
        } else {
            displaySeconds = seconds
        }

        if (minutes == 0 && seconds == 0) {
            timerBox.innerHTML = "<b>00:00</b>"
            
            setTimeout(()=>{
                clearInterval(timer)
                
            }, 500)
        }

        timerBox.innerHTML = `<b>${displayMinutes}:${displaySeconds}</b>`
        $("#current_time").val(displayMinutes)
    

        new_seconds = count - displaySeconds
        
        
        if(new_seconds >= 60){
            count_minutes = count_minutes + 1
            new_seconds = 0
            
        }
        
        total_time =  parseFloat(time)
        
        if(new_seconds.toString().length < 2){
            time_spent = count_minutes.toString() +'.0'+ new_seconds.toString()
        }
        else{
            time_spent = count_minutes.toString() +'.'+ new_seconds.toString()
        }
        
        $("#current_time").val(time_spent)


    }, 1000)
    

}


function time_avail(){

    var token = sessionStorage.getItem('Token')
    
    $.ajax({
            type: 'GET',
            url: "http://127.0.0.1:8000/api/time/",
            headers: {
                "Content-type": "application/json; charset=UTF-8",
                "Authorization": "Token " + token
            },
            success:function(data){
                
                total_time_used = 0.00
                console.log(data)
                if(data.length >0 ){
                    last_obj = Object.keys(data)[Object.keys(data).length-1];
                    total_time_used = data[last_obj]['time_calc']
                    console.log(total_time_used)
                }

                // $.each(data, function(key, value) {
                //     total_time_used = parseFloat(value['time_calc'])

                // });
                
                sessionStorage.setItem('total_time_used',total_time_used)

            }
        });
}

function logout() {
  sessionStorage.setItem('Token', '')
  sessionStorage.setItem('total_time_used', '')
  sessionStorage.setItem('subject', '')
  sessionStorage.setItem('username', '')
  location.reload()
}
</script>
{% endblock %}

